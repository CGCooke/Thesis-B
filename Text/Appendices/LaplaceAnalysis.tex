%\addcontentsline{toc}{chapter}{Appendix 2}\label{ch:LaplaceAnalysis}
\chapter{Laplace Analysis}
\label{ch:LaplaceAnalysis}

\emph{"All models are wrong, but some are useful" -George E. P. Box}

In order to have an understanding of the behaviour of the tracking loops, we must first model them. By modelling the tracking loops in the Laplace domain, we are able to get a rough idea of the behaviour of the loops. 

\input{Tables/LaplaceTestInputs}

\section{State A}
\input{Diagrams/Loops/StateA_Analog}
\input{Diagrams/Loops/StateA_Laplace}

\subsection{Open loop transfer function}
In figures \ref{fig:StateA_Analog} and \ref{fig:StateA_Laplace}, you can see analog models of the FLL used in state A. 

\begin{align*}
K_1 &= 0.125\\
K_{VCO} &= 1
\end{align*}

Then we have the open loop transfer function of 

\begin{align}
G(s) &= s  \times K_1 \times \frac{1}{s} \times  
K_{VCO} \times \frac{1}{s}\\
G(s) &= \frac{K_1 K_{VCO}}{s}
\end{align}

\subsection{Closed loop transfer function}
Converting to a closed loop transfer function :

\begin{align}
H(s) &= \frac{1}{1+\frac{K_1 K_{VCO}}{s}}\\
H(s) &= \frac{s}{s+K_1 K_{VCO}}
\end{align}

Substituting in $K_{VCO}$ and $K_1$: 
\begin{equation}
H(s) = \frac{s}{s+0.125}
\end{equation}

\subsection{Step response}
A step input in terms of phase is in the Laplace domain is characterised as  $\frac{1}{s}$

Hence the system response to a step in phase is:
\begin{equation}
error(s) = \frac{1}{s+0.125}
\end{equation}

In the time domain,
\begin{equation}
 error(t) =  e^{-0.125t}
\end{equation}


\subsection{Ramp response}
For a ramp in phase, IE, a constant frequency, then we have $\frac{1}{s^2}$

This gives:

\begin{align}
error(s) &= \frac{1}{s^2+0.125s}\\
error(s) &= \frac{8}{s} - \frac{8}{s+0.125} 
\end{align}

In the time domain:
\begin{equation}
error(t) =  8 - 8e^{-0.125t}
\end{equation}
.
Hence for constant frequency there will be a small phase error.

\subsection{Parabolic response}
For ramp input in frequency, or a parabolic input in phase, we will have 

\begin{equation}
\frac{1}{s^3}
\end{equation}

Which gives: 

\begin{align}
error(s) &= \frac{1}{s^3+0.125s^2}\\
error(s) &= \frac{8}{s^2} - \frac{64}{s} + \frac{64}{s+0.125}
\end{align}

In the time domain:
\begin{equation}
error(t) =  8t - 64 + 644 e^{-0.125}
\end{equation}

Hence there will be an increasing phase error with time, or an constant frequency error with time. If we know the frequency/phase rate, then we can work out the constant frequency error at this point.

\clearpage

\section{State B \& C}
\input{Diagrams/Loops/StateB_Analog}
\input{Diagrams/Loops/StateB_Laplace}
\subsection{Open loop transfer function}

Assuming $K_{VCO} = 1$, 

Then we have the open loop transfer function of: 

\begin{align}
G(s) &= (s \times \times K_1 + s \times K_2 + K_3 ) \times \frac{1}{s} \times K_{VCO} \times \frac{1}{s}\\
G(s) &= \frac{1}{s} (K_1 + K_2 +  \frac{K_3}{s})
\end{align}

 
\subsection{Closed loop transfer function}
This results in a close loop transfer function of 

\begin{align}
H(s) &= \frac{1}{1+\frac{1}{s} (K_1 + K_2 +  \frac{K_3}{s})}\\
H(s) &= \frac{s^2}{s^2 + (K_1 + K_2)s + K_3}
\end{align}

Where:
\begin{align*}
FLL_{BW} &=1\\
PLL_{BW} &=18\\
K_1 &=  0.04\\
K_2 &= 26.68\\
K_3 &=  2.848
\end{align*}

\begin{align}
H(s) = \frac{s^2}{s^2 + (\frac{0.04}{0.04} +  26.68)s + 2.848}\\
H(s) = \frac{s^2}{s^2 + 27.68 s + 2.848}
\end{align}

\subsection{Step response}

For an input of $\frac{1}{s}$, we have:

\begin{align}
error(s) &= \frac{s}{s^2 + 27.68 s + 2.848}\\
error(s) &= \frac{-0.003758}{s+0.1033} + \frac{1.00376}{s+27.58}
\end{align}

In the time domain:

\begin{equation}
error(t) =  -0.003758 e^{-0.103} + 1.00376 e^{-27.58}
\end{equation}

\subsection{Ramp response}

For an input of $\frac{1}{s^2}$, we have:

\begin{align}
error(s) &= \frac{1}{s^2 + 27.683 s + 2.848}\\
error(s) &=  \frac{0.0364}{s+0.1033} -\frac{0.0364}{s+27.58}
\end{align}

In the time domain:

\begin{equation}
error(t) =  0.0364e^{-0.1033} - 0.0364e^{-27.58}
\end{equation}


\subsection{Parabolic response}

For an input of $\frac{1}{s^3}$, we have:
\begin{align}
error(s) = \frac{1}{s^3 +27.683 s^2 + 2.848 s}\\
error(s) = \frac{0.3511}{s}-\frac{0.3524}{0.1033+s}
+\frac{0.001320}{27.58+s}
\end{align}

In the time domain:

\begin{equation}
error(t) = 0.3511 + 0.352 e^{-0.1032} + 0.00132 e^{-27.6}
\end{equation}

\clearpage

\section{State D}
\input{Diagrams/Loops/StateD_Analog}
\input{Diagrams/Loops/StateD_Laplace}

\subsection{Open loop transfer function}
\begin{comment}
(18, 1)
(1, array([ 0.        ,  0.01131368,  0.00022784]))
(18, 1)
(2, array([ 55.06692161,   4.63278117,   0.77306969]))
\end{comment}

\begin{align}
G(s) &= (s  \times (K_1 + \frac{1}{s} \times K_2) + K_3 \times s + K_4 + \frac{1}{s} \times K_5) \times \frac{1}{s} \times K_{VCO} \times \frac{1}{s}\\
G(s) &= (K_1 s + K_2 + K_3  s + K_4 + \frac{K_5}{s} ) \times \frac{K_{VCO}}{s^2}
\end{align}

\subsection{Closed loop transfer function}

\begin{comment}
PLL/FLL s^2 Ratio = 19.4
PLL/FLL s Ratio = 81.3339
\end{comment}

\begin{align}
H(s) &= \frac{1}{1+(K_1 s + K_2 + K_3  s +K_4  + \frac{K_5}{s}  \times \frac{K_{VCO}}{s^2}}\\
H(s) &= \frac{s^3}{s^3 + K_{VCO}(K_1 s^2 + K_2 s + K_3 s^2 + K_4 s + K_5)}
\end{align}

Where:
\begin{align*}
FLL_{BW}&=1\\
PLL_{BW}&=18\\
K_1 &=  0.01131\\
K_2 &=  0.0002278\\
K_3 &= 55.07\\
K_4 &= 4.633\\
K_5 &= 0.7731
\end{align*}

\begin{align}
H(s) &= \frac{s^3}{s^3 +2.828 s^2 + 0.05696 s + 55.07 s^2 + 4.633 s + 0.7731}\\
H(s) &= \frac{s^3}{s^3 +57.90 s^2 + 4.690 s +0.7731}
\end{align}

\subsection{Step response}

A step input is $\frac{1}{s}$

\begin{align}
error(s) &= \frac{s^2}{s^3 +57.90 s^2 + 4.690 s +0.7731}\\
error(s) &=\frac{-0.001397 s - 0.0002316}{s^2 + 0.08087 s + 0.01337} + \frac{1.001}{s + 57.81}
\end{align}

\subsection{Ramp response}

\begin{align}
error(s) &= \frac{s}{s^3 +57.90 s^2 + 4.690 s +0.7731}\\
error(s) &= \frac{0.01732 s + 0.000004006}{s^2 +0.08089 s +0.01337} - \frac{0.01732}{s + 57.81}
\end{align}

\subsection{Parabolic response}

\begin{align}
error(s) &= \frac{1}{s^3 +57.90 s^2 + 4.690 s +0.7731}\\
error(s) &= \frac{-0.0002996 s + 0.01730}{s^2 + 0.08089 s + 0.01337}+\frac{0.0002996}{s+ 57.81}
\end{align}


